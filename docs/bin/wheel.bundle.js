var app=function(e,t,s,r,i){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,s=s&&s.hasOwnProperty("default")?s.default:s,r=r&&r.hasOwnProperty("default")?r.default:r;const a=(e,t=!1)=>t?{__proto__:e,...t}:t=>a(e,t),n=e=>t=>Object.fromEntries(Object.entries(e).reduce((e,[s,r])=>{const i=t([s,r]);return i&&e.push(i),e},[])),o=e=>t=>Object.entries(e).forEach(t),c=e=>(t,s)=>Object.entries(e).reduce(t,s),l=Object.keys,h=Object.values,u=e=>c(e.get())((e,[t,s])=>"&"===t[0]?e:(e[t]=s.toJSON(),e),{}),d={toJSON(){switch(typeof this.value){case"undefined":case"number":case"string":return this.value;case"object":if(Array.isArray(this.value)||null===this.value)return this.value;if(this.value.toJSON)return this.value.toJSON()}return JSON.parse(JSON.stringify(this.value))}},v=new Set,g=()=>{requestAnimationFrame(g),v.clear()};g();const p=a(d,{get(){return this.value},notify(){if(this.subs){if(v.has(this))return requestAnimationFrame(()=>{v.has(this)||this.notify()});v.add(this),this.subs.forEach(e=>e(this.value))}},subscribe(e,t=!1){return this.subs||(this.subs=new Set),this.subs.add(e),t||e(this.value),()=>this.subs.delete(e)},listen(e){return this.subscribe(e)}}),m=(e,t)=>{const s=a(p,(e=>a(d,{value:e}))(e));return t&&t(e=>{s.value=e,s.notify(e)}),s},f=a(p,{set(e,t=!1){this.value=void 0===e?null:e,t||this.notify()},update(e){this.set(e(this.value))}}),w=e=>a(f,m(e)),y=a(f,{get(e=!1){const t=f.get.call(this);return!1===e?t:t[e]},set(e,t=!1){this.value=e;const{previous:s}=this,r=[];t||this.notify({add:l(e).filter(t=>{const i=void 0===s[t];return i||s[t]===e[t]||r.push(t),i}),remove:l(s).filter(t=>void 0===e[t]),modify:r,previous:s}),this.previous={__proto__:e.__proto__,...e}},subscribe(e){return e(this.value,{add:l(this.value),remove:[],modify:[],previous:this.value}),f.subscribe.call(this,e,!0)},notify(e){this.subs&&e&&this.subs.forEach(t=>t(this.value,e))}}),b=(e={})=>a(y,{...w(e),previous:{...e}}),_=a(y,{has(e){return void 0!==this.get(e)},get(e=!1){const t=y.get.call(this);return!1===e?t:t[e]},set(e,t=!1){const s={__proto__:e.__proto__,...n(e)(([e,t])=>[e,this.convert(t)])};y.set.call(this,s,t)},convert(e){return e&&"function"==typeof e.subscribe?e:this.fn?w(this.fn(e)):w(e)},add(e){return this.set(Object.assign(this.get(),e)),this},write(e){const t={};o(e)(([e,s])=>{const r=this.get()[e];r?r.set(s):t[e]="object"==typeof s&&null!==s&&s.get?s:w(s)}),Object.keys(t).length>0&&this.add(t)},remove(e){const t=this.get();delete t[e],y.set.call(this,t)},toJSON(){return u(this)}}),z=(e={},t=!1)=>{const s=a(_,{...b({}),fn:t});return s.set(e),s},O=a(f,{set(e){return f.set.call(this,this.transform(e)),this}}),E=e=>a(O,{...w(),transform:e}),S=w(100),$=(m("/sheets/default_2.png"),m("localhost:5000"===window.location.host),w(!1),w({delay:100,duration:300}),w(!0),w(!1),w(10),w(.01),w(.1),m(1024),m(32),w("rgb(224, 168, 83)"),w("#033")),j=(w("green"),w("#023d55"),w("/sys"),m("",e=>$.listen(s=>e(t(s).darkenByRatio(.5).toCSS())))),N=(m("",e=>{let t="";j.listen(s=>{t=s,e([`border: 0.2rem solid ${t};`].join(""))})}),["groovy","cat","bird","dog","poop","cool","not","okay","great","terrible","wat","goblin","life","ferret","gregert","robert","zilla","red","shirt","pants","blue","luna","ember","embear","lunatic","boring","killa","notice","thank","tank","under","near","near","quaint","potato","egg","bacon","narwhal","lamp","stairs","king","tyrant","grave","dire","happy","amazing","terrific","terrible","good","boring","rip","hello","world","global","universal","television","computer"]),A=e=>Array.from(new Array(e)).map(()=>N[Math.floor(Math.random()*N.length)]).join(" "),J={listen(e){return this.value.listen(e)},get(){return this.value.get()},set(e){return this.value.set(e)},toJSON(){return{type:this.type.get(),value:this.value.toJSON()}}};var k=a({cancel(){const e=[...this.birds];requestAnimationFrame(()=>{this.weave.remove(...e)})},rez(){const{value:e,space:t,weave:r}=this;this.birds=[],this.value_cancel=e.listen(e=>{const i=e.split(" ");let a=1;i.length>1&&(a=parseInt(i[0]),e=i.slice(1).join(" ")),this.cancel();const n=Object.fromEntries([...Array(a)].map((r,i)=>[`&${s()}`,{type:"space",value:{"!clone":e,"!leader":`~/${t.value.get("!name").get()}`,"!bird":i}}]));requestAnimationFrame(()=>{this.birds=Object.values(r.write_ids(n)).map(e=>e.id.get()),this.weave.rez(...this.birds)})})},derez(){this.value_cancel(),this.cancel()}});const F={stream:e=>JSON.stringify(e.value.get()),math:e=>e.math.get().trim(),mail:e=>e.whom.get().trim(),default:e=>e.warp.get(),space:e=>`./${e.value.get("!name")}`,sprite:e=>`@${e.value.get()}`,color:e=>`#${e.value.get()}`},W={color:e=>"#"===e[0],sprite:e=>"@"===e[0],mail:e=>{const t=e.match(Wheel.REG_ID);return!(!t||1!==t.length)&&t[0]===e},stream:e=>{try{return JSON.parse(e),!0}catch(e){return!1}}},q={math:e=>({type:"math",math:e}),mail:e=>({type:"mail",whom:e}),stream:e=>({type:"stream",value:JSON.parse(e)}),color:e=>({type:"color",value:e.slice(1)}),sprite:e=>{let t=parseInt(e.slice(1));return isNaN(t)&&(t=66),{type:"sprite",value:t}}},x=e=>{const t=(e=>{const t=Object.entries(W);for(let s=0;s<t.length;s++){const[r,i]=t[s];if(i(e))return r}return"math"})(e);return q[t](e)},I=(e,t)=>t.chain(e).slice(0,-1).map(e=>M(e,t)).join(" => "),M=(e,t)=>{if("{"===e[0])return e;const s=t.warps.get()[e];if(!s)return"space";const r=s.type.get();return F[r]?F[r](s):r},D=({code:e,weave:t,address:r,prefix:i=""})=>{const a=e.replace(/[\r\n]/g,"").split("=>").reverse(),n=t.wefts.get();t.remove(...t.chain(r).slice(0,-1));const o=t.get_id(r.split("/")[0]);let c=r;const l=a.map(e=>{if(""===(e=e.trim()))return;const r=x(e);r.id=`${i}${s()}`;const a=t.add(r).id.get();return n[a]=c,c=a,a});return o.rezed&&t.rez(...l),t.wefts.set(n),l};var R=a({grab_script(e,t){const s=e.weave,r=`${e.id.get()}/${t}`;if(0===s.chain(r).slice(0,-1).length)return;const{weave:i,id:a,space:n}=this,o=I(r,s),c=`${a}/${t}`,l=s.get_id(e.id.get()).value.get(t).get();n.value.has(t)||n.value.write({[t]:l}),requestAnimationFrame(()=>{this.scripts.push(...D({code:o,weave:i,address:c,prefix:"&"}))})},rez(){const{space:e,weave:t,value:s,id:r}=this;this.scripts=this.scripts||[],this.cancel=s.listen(s=>{this.weave.remove(...this.scripts);const i=Wheel.get(t.resolve(s,r));i||console.warn("Invid other for clone");const a=i?i.value.get():{};l(a).forEach(e=>{this.grab_script(i,e)}),e.set({...e.get(),__proto__:a},!0)})},derez(){this.cancel(),this.space.set({...this.space.get()},!0),this.weave.remove(...this.scripts)}}),P=a({rez(){this.cancel=this.value.listen(e=>{const t=this.space.id.get(),s=Wheel.get(this.weave.resolve(e,t));if(!s)return void console.warn("leader not found");const r=s.value.get();if(!r["!birds"])return r["!birds"]=w(new Set([t])),void s.value.set(r);let i=r["!birds"].get();i.add||Array.isArray(i)||(i=new Set),Array.isArray(i)&&(i=new Set(i)),i.has(t)||(i.add(t),r["!birds"].set([...i]))})},derez(){const e=this.space.id.get();this.cancel();const t=Wheel.get(this.weave.resolve(this.value.get(),e));if(!t)return void console.warn("no leader");const s=t.value.get();if(!s)return void console.warn("no leader value");let r=s["!birds"].get();r.add||Array.isArray(r)||(r=new Set),Array.isArray(r)&&(r=new Set(r)),r.delete(e),s["!birds"].set([...r])}}),C=a({create(){this.cancel=this.value.listen(e=>{const t=this.weave.names.get();if(this.name_last){if(this.name_last===e)return;delete t[this.name_last]}t[e]=this.space,this.name_last=e,this.weave.names.set(t)})},destroy(){this.cancel(),this.weave.names.update(e=>(delete e[this.name_last],e))}}),G=a({create(){requestAnimationFrame(()=>{this.value.set([])})}});let T;const B=m(0,e=>{T=e});let Y=Date.now();m([0,0],e=>{let t;const s=[0,0],r=i=>{requestAnimationFrame(r),void 0===t&&(t=i),s[0]=i,s[1]=Math.round(i-t),t=i;const a=Date.now();a-Y>=S.get()&&(Y=a,T(B.get()+1)),e(s)};requestAnimationFrame(r)});const Z=new Worker("/bin/physics.bundle.js"),H=w({}),K=()=>requestAnimationFrame(()=>{const e=n(H.get())(([e,t])=>{const s=t.get();return[e,{id:e,position:Q(s.position,[0,0,0]),"!velocity":Q(s["!velocity"],[0,0,0]),scale:Q(s.scale,1),"!real":Q(s["!real"],!1),"!name":Q(s["!name"],`id-${e}`),mass:Q(s.mass,1),"!force":Q(s["!force"],void 0)}]});Z.postMessage({type:"solve",data:e})});let L=()=>{K()};Z.onmessage=({data:e})=>{L=()=>{const t=H.get();o(e.bodies)(([e,s])=>{const r=t[e];r&&r.write(s)}),K()}};const Q=(e,t)=>e?e.get():t;B.listen(()=>{L()});var U=a({rez(){((...e)=>{const t=H.get();e.forEach(e=>{t[e.id.get()]=e.value}),H.set(t,!0)})(this.space)},derez(){((...e)=>{const t=H.get();e.forEach(e=>{delete t[e.id.get()]}),H.set(t,!0)})(this.space)}}),V=a({create(){this.value.set(void 0,!0),this.cancel=this.value.listen(()=>{})}});const X={};var ee=a({rez(){X[this.space.id.get()]=this.space},derez(){delete X[this.space.id.get()]}}),te=Object.freeze({__proto__:null,flock:k,clone:R,leader:P,name:C,birds:G,velocity:U,real:U,collide:V,visible:ee,force:U});const se=m(""),re=m("space"),ie=a(J,{address(){return`/${this.weave.name.get()}/${this.name().get()||this.id.get()}`},name(){return this.value.get("!name")||se},create(){const e=this.id.get();this.twists={},this.cancel=this.value.listen((t,{add:s,remove:r})=>{(e=>(...t)=>Object.assign(e,...t))(this.twists)(s.reduce((e,s)=>{const r=te[s.slice(1)];if(void 0===r)return e;const i=r({weave:this.weave,value:t[s],space:this,id:this.id.get()});return i.create&&i.create(),this.rezed&&i.rez&&requestAnimationFrame(()=>i.rez()),e[s]=i,e},{})),r.forEach(t=>{const s=this.twists[t];this.weave.remove(...this.weave.chain(`${e}/${t}`).slice(0,-1)),s&&(this.rezed&&s.derez&&s.derez(),s.destroy&&s.destroy(),delete this.twists[t])})})},destroy(){this.cancel(),o(this.twists)(([e,t])=>{this.rezed&&t.derez&&t.derez(),t.destroy&&t.destroy()}),this.twists={}},rez(){this.rezed=!0,o(this.twists)(([e,t])=>{t.rez&&t.rez()})},derez(){this.rezed=!1,o(this.twists)(([e,t])=>{t.derez&&t.derez()})},chain(){const e=this.value.get(),t=this.id.get();return l(e).reduce((e,s)=>(e.push(...this.weave.chain(`${t}/${s}`).slice(0,-1)),e),[])},get(e){return this.value.get(e)},gets(...e){return e.reduce((e,t)=>(e[t]=this.get(t),e),{})},get_value(e){const t=this.value.get(e);if(t)return t.get()},get_values(...e){return e.reduce((e,t)=>(e[t]=this.get_value(t),e),{})},write(e){return this.value.write(e)}});const ae=m("stream"),ne=a(f,{set(e){try{f.set.call(this,(e=>{if(-1===e.indexOf(".")){const t=parseInt(e);if("number"==typeof t&&!isNaN(t))return t}return JSON.parse(e)})(e))}catch(t){f.set.call(this,e)}return this}});const oe=m("sprite");const ce=e=>{const s=t(e);return void 0===s.red?16777215:s.red+255*s.green+255*s.blue},le=m("color");i.v3.setDefaultType(Array);const he={},ue=new r.Parser({in:!0,assignment:!0});ue.functions.stop=function(){throw new Error("stop")},Object.entries(i.v3).forEach(([e,t])=>{ue.functions[`v3_${e}`]=function(...e){return t(...e)}}),Object.entries(i.m4).forEach(([e,t])=>{ue.functions[`m4_${e}`]=function(...e){return t(...e)}}),ue.functions.Color=t;const de=()=>{},ve=/[ .~%!&/^]/g,ge=/[.*+?^${}()|[\]\\]/g,pe=/\.\//g,me=/~\//g,fe=/\$/g,we=m("math"),ye=a(J,{run(e){const t=e.match(Wheel.REG_ID),s={},r=this.weave.chain(this.id.get(),!0).shift(),i=this.weave.to_address(r);new Set(t).forEach(t=>{const r="$"===t[0],a=t.replace(pe,`${i}/`).replace(me,`/${this.weave.name.get()}/`).replace(fe,"").trim(),n=Wheel.get(a);if(!n)return;const o=t.replace(pe,"dot").replace(me,"weave").replace(ve,"z");e=e.replace(new RegExp((e=>e.replace(ge,"\\$&"))(t),"g"),o),s[o]={warp:n,shh:r}});try{this.fn=(e=>{let t=he[e];return t||(t=ue.parse(e),he[e]=t),e=>t.evaluate(e)})(e),this.values.set(s)}catch(e){}},rez(){this.run(this.math.get()),this.cancels=new Set,this.cancel_vs=this.values.listen(e=>{this.cancels.forEach(e=>e()),this.cancels.clear(),Object.entries(e).forEach(([e,{warp:t,shh:s}])=>{s||this.cancels.add(t.listen(()=>{this.value.set(this.value.last)}))})})},derez(){this.cancel_vs(),this.cancels.forEach(e=>e())},toJSON(){return{type:this.type.get(),value:this.value.get(),math:this.math.get()}}}),be=a(f,{set(e){return this.warp.run(e),e}}),_e=a(f,{set(e){this.last=e;const t=this.warp.values.get();e=void 0===e?null:e;const s={...Object.fromEntries(Object.entries(t).map(([e,{warp:t}])=>[e,void 0===t.toJSON()?null:t.toJSON()])),value:e};try{const e=this.warp.fn(s);f.set.call(this,e)}catch(e){"stop"!==e.message&&console.warn("math error",e)}return this}});const ze=m("mail"),Oe=a(J,{fix(e){return e.replace("$","").replace("~",`/${this.weave.name.get()}`).replace(".",this.weave.to_address(this.weave.chain(this.id.get(),!0).shift()))},clear(){this.cancels.forEach(e=>e()),this.cancels.clear()},derez(){this.cancel_whom(),this.clear()},rez(){this.cancels=new Set,this.cancel_whom=this.whom.listen(e=>{if(this.clear(),"$"===(e=this.weave.resolve(e,this.id.get()))[0]){e=e.replace("$","");const t=Wheel.get(e);return t?void this.set(t.get()):this.set(null)}let t=Wheel.get(e);t&&(t=t.type?t.value:t,this.cancels.add(t.listen(e=>{this.set(e)})))})},toJSON(){return{type:this.type.get(),value:this.value.get(),whom:this.whom.get()}},set(e){f.set.call(this.value,e)}}),Ee=a(f,{set(e){const t=this.mail.fix(this.mail.whom.get()),s=Wheel.get(t);s&&s.set&&(s.set(e),f.set.call(this,e))}});var Se=Object.freeze({__proto__:null,space:({id:e,value:t={},weave:s})=>a(ie,{type:re,value:z(t),id:m(e),weave:s}),stream:({id:e,value:t=null})=>a(J,{type:ae,value:a(ne,w()).set(t),id:m(e)}),sprite:({value:e=0,id:t})=>a(J,{type:oe,value:w(e),id:m(t)}),color:({value:e="#FFFFFF",id:t})=>a(J,{type:le,value:E(ce).set(e),id:m(t)}),math:({math:e="2+2",value:t,weave:s,id:r}=!1)=>{const i=a(ye,{type:we,values:w({}),id:m(r),weave:s,fn:de});return i.value=a(_e,{...w(t),warp:i}),i.math=a(be,{...w(e),warp:i}),requestAnimationFrame(()=>{i.math.set(e)}),i},mail:({whom:e="/sys/mouse/position",weave:t,id:s})=>{const r=a(Oe,{type:ze,whom:w(e),id:m(s),weave:t});return r.value=a(Ee,{...w(),mail:r}),r}});const $e={is_rezed(){return void 0!==Wheel.running.get()[this.name.get()]},add(e){e.id=e.id||s();const t=this.make(e);if(t)return this.warps.update(e=>(e[t.id.get()]=t,e)),t.create&&t.create(),t},remove_unnamed(){const e=this.warps.get(),t=[];return Object.keys(e).forEach(e=>{"&"===e[0]&&t.push(e)}),this.remove(...t),t.length},remove_name(e){const t=this.get_name(e);if(!t)return;const s=t.id.get();return this.remove(s)},remove(...e){this.warps.update(t=>{let s;const r=this.rezed.get(),i=this.is_rezed(),a=this.wefts.get();let n=!1;return e.forEach(e=>{a[e]&&(n=!0,delete a[e]);const o=t[e];o&&(i&&r[e]&&(s=!0,delete r[e],o.derez&&o.derez()),o.destroy&&o.destroy(),delete t[e])}),s&&this.rezed.set(r,!0),n&&this.wefts.set(a),t})},write_ids(e){const t=this.warps.get();return n(e)(([e,s])=>{const r=t[e];if(!r){s.value=s.value||{},s.id=e;const t=this.add(s);return t?[e,t]:[e,!1]}return o(s)(([e,t])=>{const s=r[e];"value"!==e?s.set&&s.set(t):s.set(Object.assign(s.get(),t))}),[e,r]})},write(e){const t=this.names.get();return n(e)(([e,s])=>{const r=t[e];if(!r){s.value=s.value||{},s.value["!name"]=e;const t=this.add(s);return t?[e,t]:[e,!1]}return o(s)(([e,t])=>{const s=r[e];"value"!==e?s.set&&s.set(t):s.set(Object.assign(s.get(),t))}),[e,r]})},exists(e){const[t,s]=e.split("/"),r=this.warps.get()[t];return!!r&&(void 0===s||void 0!==r.value.get()[s])},validate(){let e=!1;const t=this.wefts.get(),s=this.warps.get(),r=[];return o(s)(([e,t])=>{if("space"===t.type.get())return;const i=this.chain(t.id.get(),!0),a=i[i.length-1].split("/")[0],n=i[0].split("/")[0],o=s[a],c=s[n];o&&"space"===o.type.get()||c&&"space"===c.type.get()||r.push(t.id.get())}),r.length>0&&this.remove(...r),o(t)(([s,r])=>{this.exists(s)&&this.exists(r)||(e=!0,delete t[s])}),e?(this.wefts.set(t),r.length):r.length},chain(e,t=!1){const s=t?this.wefts.get()[e]:this.wefts_r.get()[e];return s?[...this.chain(s,t),e]:[e]},to_address(e){const[t]=e.split("/"),s=this.get_id(t);return`/${this.name.get()}/${s.id.get()}`},get_name(e){return this.names.get()[e]},get_id(e){if(!e)return;const[t,s]=e.split("/"),r=this.warps.get()[t];if(!s)return r;if(!r)return;const i=r.value.get();return i&&i[s]?{value:i[s]}:void 0},make(e){return(({id:e=s(),type:t,knot:r,...i}=!1)=>{return!t&&r&&(t=r),"stitch"===t&&(t="space",i.value=i.value||{},i.value["!name"]=i.name),Se[t]?Se[t]({...i,id:e}):(console.warn(`Invalid warp ${t}`),!1)})({...e,weave:this})},resolve(e,t){return e.replace(".",this.to_address(this.chain(t,!0).shift())).replace("~",this.name.get())},derez(...e){const t=this.rezed.get(),s=this.warps.get();e.forEach(e=>{const r=s[e];r&&"space"===r.type.get()&&this.derez(...s[e].chain()),delete t[e]}),this.rezed.set(t)},rez(...e){const t=this.rezed.get(),s=this.warps.get();e.forEach(e=>{const r=s[e];r&&("space"===r.type.get()&&this.rez(...r.chain()),t[e]=!0)}),this.rezed.set(t)},destroy(){this.destroys.forEach(e=>e())},toJSON(){return{id:this.id.toJSON(),name:this.name.toJSON(),wefts:this.wefts.toJSON(),warps:u(this.warps),rezed:this.rezed.toJSON()}}};var je=({name:e=A(2),id:t=s(),warps:r={},wefts:i={},rezed:n={},knots:l,threads:h}=!1)=>{l&&(r=l),h&&(i=h);const u=a($e,{id:m(t),name:w(e),wefts:b(i),rezed:b(n),names:w({}),spaces:w(new Map),destroys:[]}),d=c(r)((e,[t,s])=>{s.id!==t&&(s.id=t);const r=u.make(s);return r?(e[t]=r,e):e},{});return o(d)(([e,t])=>t.create&&t.create()),u.warps=w(d),u.wefts_r=m({},e=>{const t={};u.destroys.push(u.wefts.listen((s,{add:r,remove:i,modify:a,previous:n})=>{i.forEach(e=>{delete t[n[e]]}),r.forEach(e=>{t[s[e]]=e}),a.forEach(e=>{t[s[e]]=e}),e(t)}))}),u};const Ne=w({sys:je({name:"sys",id:"sys"})}),Ae=new Map;let Je;const ke=m({sys:!0},e=>{Je=e}),Fe=w(),We=w(""),qe=e=>{const[t,s,r]=(e=>{let t=e.split("/");return""===t[0]&&(t=t.slice(1)),t})(e),i=Ne.get()[t];if(void 0===i)return;if(void 0===s)return i;let a=i.names.get()[s];if(void 0===a&&(a=i.warps.get()[s],!a))return;if(void 0===r)return a;const n=a.value.get();if(!n)return;const o=n[r];return void 0!==o?o:void 0},xe=e=>{if("sys"===e)return;const t=Ae.get(e);void 0!==t&&(t(),Ae.delete(e));const s=ke.get();delete s[e],Je(s)},Ie=()=>{const e=Ne.get();l(e).forEach(e=>xe(e))};return e.REG_ID=/\$?[~.]?\/[a-zA-Z 0-9!%&/]+/g,e.SYSTEM="sys",e.clear=()=>{Ie(),Ne.set({sys:Ne.get().sys})},e.compile=D,e.condense=(e,t)=>{const s=M(e,t).split(";"),r=s.pop().trim();return s.length>0?`{${s.length}} ${r}`:r},e.decompile=I,e.del=e=>{const t=ke.get(),s=Ne.get();let r=!1;Object.keys(e).forEach(e=>{"sys"!==e&&(t[e]&&xe(e),s[e]&&(r=!0,s[e].destroy(),Fe.set(s[e]),delete s[e]))}),r&&Ne.set(s)},e.exists=e=>void 0!==qe(e),e.format=e=>e=(e=(e=e.split(";")).map((t,s)=>(t=t.trim(),s!==e.length-1&&(t+=";"),s===e.length-2&&(t+="\r\n"),t)).join("\r\n")).split("=>").join("\r\n\r\n=>"),e.get=qe,e.name=We,e.restart=e=>{Wheel.stop(e),Wheel.start(e)},e.running=ke,e.shared={},e.spawn=(e={})=>n(e)(([e,t])=>{if("sys"===e)return console.warn("tried to spawn sys"),[e,qe(e)];const s=Ne.get(),r=je({...t,name:e});return s[e]=r,Ne.set(s),[e,r]}),e.start=e=>{if("sys"===e)return;const t=qe(e);if(!t)return!1;const s=(e=>{const t={},s=e.wefts.listen((s,{add:r,remove:i,modify:a})=>{let n;[...r,...a].forEach(r=>{const i=s[r],a=e.get_id(r),o=e.get_id(i);if(!o||!a)return n=!0,void delete s[r];t[r]&&t[r](),t[r]=a.value.subscribe(e=>{a.rezed&&o.value.set(e)})}),i.forEach(e=>{const s=t[e];s&&(s(),delete t[e])}),n&&e.wefts.set(s,!0)});return()=>{s(),h(t).forEach(e=>e())}})(t),r=(e=>{const t=e.rezed.listen((t,{add:s,remove:r})=>{const i=[],a=e.warps.get();s.forEach(e=>{const s=a[e];if(!s)return delete t[e],i.push(e);s.rez&&s.rez(),s.rezed=!0,s.value.notify()}),r.forEach(e=>{const s=a[e];if(!s)return delete t[e],i.push(e);s.derez&&s.derez(),delete s.rezed}),i.length>0&&e.rezed.set(t,!0)});return()=>{t(),h(e.rezed.get()).forEach(e=>e&&e.derez&&e.derez())}})(t);Ae.set(e,()=>{s(),r()}),Je({...ke.get(),[e]:!0})},e.stop=xe,e.stop_all=Ie,e.toJSON=()=>({name:We.get(),weaves:u(Ne),running:ke.toJSON()}),e.translate=M,e.trash=Fe,e.weaves=Ne,e}({},Color,cuid,exprEval,twgl);
